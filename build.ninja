out_dir = temp/game/main
out_data_dir = $out_dir/data

title = NorthAndSouthWars
exe = $out_dir/a.exe
shrinkled_exe = temp/shrinkler/exe.fast.shrinkled
lz = temp/lz/lz
adf = temp/adf/$title.adf
zip = temp/dist/$title.zip
kingcon = external/kingcon/build/kingcon

rule build_adf
  command = xdftool $out format "$title" + boot install && xdftool $out write adf/S S && xdftool $out write $shrinkled_exe $title && xdftool $out write $out_data_dir && xdftool $out list

rule cat
  command = cat $in >$out

rule cc
  command = gcc -O2 $in -o $out

rule cmake-build
  command = cmake --build --preset amiga

rule cmake-configure
  command = cmake --preset amiga

rule kingcon-bpl
  command = $kingcon $in $basename -Format=5 -Interleaved

rule kingcon-bpl-mask
  command = $kingcon $in $basename -Format=5 -Interleaved -Mask

rule lz
  command = $lz -o $out $in

rule make
  command = make -j4

rule shrinkle
  command = Shrinkler -h -o -9 $in $out

rule zip
  command = zip -9 -j -v $out $in

build always: phony
build temp/build.ninja: cmake-configure CMakeLists.txt CMakePresets.json
build $exe: cmake-build | always temp/build.ninja
build $shrinkled_exe: shrinkle $exe
build temp/assets/mission/arrows.BPL: make | always
build temp/assets/mission/tiles.bpl: make | always
build temp/assets/mission/units.BPL: make | always
build temp/assets/mission/menu.BPL: make | always

build temp/assets/mission/encounter/bg_bridge.png: make | always
build temp/assets/mission/encounter/bg_mountain.png: make | always
build temp/assets/mission/encounter/bg_plain.png: make | always
build temp/assets/mission/encounter/bg_road.png: make | always
build temp/assets/mission/encounter/bg_woods.png: make | always
build temp/assets/mission/encounter/units.png: make | always

build temp/assets/mission/encounter/bg_bridge.BPL: kingcon-bpl temp/assets/mission/encounter/bg_bridge.png
  basename = temp/assets/mission/encounter/bg_bridge
build temp/assets/mission/encounter/bg_mountain.BPL: kingcon-bpl temp/assets/mission/encounter/bg_mountain.png
  basename = temp/assets/mission/encounter/bg_mountain
build temp/assets/mission/encounter/bg_plain.BPL: kingcon-bpl temp/assets/mission/encounter/bg_plain.png
  basename = temp/assets/mission/encounter/bg_plain
build temp/assets/mission/encounter/bg_road.BPL: kingcon-bpl temp/assets/mission/encounter/bg_road.png
  basename = temp/assets/mission/encounter/bg_road
build temp/assets/mission/encounter/bg_woods.BPL: kingcon-bpl temp/assets/mission/encounter/bg_woods.png
  basename = temp/assets/mission/encounter/bg_woods
build temp/assets/mission/encounter/units.BPL: kingcon-bpl-mask temp/assets/mission/encounter/units.png
  basename = temp/assets/mission/encounter/units

build temp/assets/mission.chip: cat temp/assets/mission/arrows.BPL temp/assets/mission/tiles.bpl temp/assets/mission/units.BPL temp/assets/mission/menu.BPL temp/assets/mission/encounter/bg_bridge.BPL temp/assets/mission/encounter/bg_mountain.BPL temp/assets/mission/encounter/bg_plain.BPL temp/assets/mission/encounter/bg_road.BPL temp/assets/mission/encounter/bg_woods.BPL temp/assets/mission/encounter/units.BPL
build $lz: cc external/doynamite68k/lz.c
build $out_data_dir/mission.chip.lz: lz temp/assets/mission.chip | $lz
build $adf: build_adf $shrinkled_exe adf/S/startup-sequence $out_data_dir/mission.chip.lz
build $zip: zip $adf dist/ReadMe.txt
